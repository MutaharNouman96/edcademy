<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ed‑Cademy — Lesson Analytics</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>

  <!-- jQuery, DataTables (Bootstrap 5 theme) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"/>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --primary-cyan:#006b7d;  /* match Courses & Lessons pages */
      --dark-cyan:#004a57;
      --light-cyan:#e0f7fa;
      --bg-soft:#f6f8f9;
    }
    body{background:var(--bg-soft);} 
    .brand{color:var(--primary-cyan);font-weight:700;} 
    .header{position:sticky;top:0;z-index:1020;background:#fff;border-bottom:1px solid rgba(0,0,0,.06);} 
    .sidebar{position:sticky;top:0;height:100dvh;overflow-y:auto;background:#fff;border-right:1px solid rgba(0,0,0,.06);} 
    .sidebar .nav-link{color:#425466;border-radius:.5rem;} 
    .sidebar .nav-link.active{background:var(--light-cyan);color:var(--dark-cyan);font-weight:600;} 
    .sidebar .nav-link:hover{background:rgba(0,107,125,.08);color:var(--dark-cyan);} 
    .btn-primary{background:var(--primary-cyan);border-color:var(--primary-cyan);} 
    .btn-primary:hover{background:var(--dark-cyan);border-color:var(--dark-cyan);} 
    .card{border-radius:16px;} 
    .section-header{background:var(--light-cyan);border-radius:16px 16px 0 0;padding:1.25rem;border-bottom:1px solid rgba(0,0,0,.06);} 
    .section-title{color:var(--dark-cyan);font-weight:700;margin:0;display:flex;gap:.5rem;align-items:center;} 
    .kpi{border-radius:14px;border:1px solid rgba(0,0,0,.06);background:#fff;padding:1rem;} 
    .kpi .label{color:#6b7a8c;font-size:.85rem;} 
    .kpi .value{font-weight:700;font-size:1.6rem;color:#0f172a;} 
    .badge-live{background:rgba(220,53,69,.12);color:#dc3545;border-radius:999px;padding:.3rem .6rem;display:inline-flex;align-items:center;gap:.35rem;} 
    .badge-live .dot{width:6px;height:6px;border-radius:50%;background:#dc3545;display:inline-block;animation:pulse 1.2s infinite;} 
    @keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}} 
    .status-badge{font-size:.75rem;padding:.35rem .6rem;border-radius:999px} 
    .status-watching{background:rgba(13,110,253,.12);color:#0d6efd;} 
    .status-offline{background:rgba(108,117,125,.12);color:#6c757d;} 
    .progress{height:8px;} 
    .avatar{width:36px;height:36px;border-radius:999px;object-fit:cover;border:1px solid rgba(0,0,0,.08);} 
    .chart-card{padding:1rem 1rem 1.25rem 1rem;} 
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header py-2">
    <div class="container-fluid px-4">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
          <a href="/educator/courses" class="text-decoration-none brand">
            <i class="bi bi-mortarboard-fill me-2"></i>Ed‑Cademy
          </a>
          <nav aria-label="breadcrumb" class="d-none d-md-block">
            <ol class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a href="/educator/courses" class="text-decoration-none">Courses</a></li>
              <li class="breadcrumb-item"><a id="crumbCourse" href="#" class="text-decoration-none">Course</a></li>
              <li class="breadcrumb-item"><a id="crumbLessons" href="#" class="text-decoration-none">Lessons</a></li>
              <li class="breadcrumb-item active" aria-current="page">Analytics</li>
            </ol>
          </nav>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="btnOpenLesson" class="btn btn-sm btn-outline-secondary"><i class="bi bi-eye me-1"></i> Open lesson</button>
          <button id="btnBackLessons" class="btn btn-sm btn-primary"><i class="bi bi-arrow-left me-1"></i> Back to lessons</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <aside class="col-12 col-md-3 col-lg-2 sidebar p-3">
        <nav class="nav flex-column gap-1">
          <a class="nav-link" href="/educator"><i class="bi bi-speedometer2 me-2"></i> Overview</a>
          <a class="nav-link active" href="/educator/courses"><i class="bi bi-journal-code me-2"></i> My Courses</a>
          <a class="nav-link" href="#section-analytics"><i class="bi bi-graph-up me-2"></i> Analytics</a>
          <a class="nav-link" href="#section-attendees"><i class="bi bi-people me-2"></i> Attendees</a>
        </nav>
        <hr/>
        <div class="p-3 rounded" style="background:var(--light-cyan);">
          <div class="d-flex align-items-start gap-2">
            <i class="bi bi-info-circle-fill text-primary fs-5"></i>
            <div>
              <strong>Tip:</strong>
              <p class="mb-2 small">This page auto-refreshes live stats every 15 seconds.</p>
              <div id="liveBadge" class="badge-live"><span class="dot"></span> Live</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main class="col-12 col-md-9 col-lg-10 p-4">
        <!-- KPIs -->
        <section id="section-analytics">
          <div class="card shadow-sm mb-4">
            <div class="section-header d-flex justify-content-between align-items-center">
              <h2 class="section-title"><i class="bi bi-graph-up"></i> Lesson Analytics <span id="lessonTitleSpan" class="ms-2 text-muted fs-6"></span></h2>
              <div class="d-flex gap-2">
                <input type="date" id="fromDate" class="form-control form-control-sm"/>
                <input type="date" id="toDate" class="form-control form-control-sm"/>
                <button id="btnApplyRange" class="btn btn-sm btn-outline-secondary"><i class="bi bi-funnel me-1"></i>Apply</button>
              </div>
            </div>
            <div class="p-3">
              <div class="row g-3">
                <div class="col-12 col-md-6 col-lg-3">
                  <div class="kpi">
                    <div class="label">Attending now</div>
                    <div class="value" id="kpiAttending">—</div>
                    <div class="small text-muted" id="kpiAttendingHint">updating…</div>
                  </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                  <div class="kpi">
                    <div class="label">Unique students watched</div>
                    <div class="value" id="kpiWatched">—</div>
                    <div class="small text-muted">in selected range</div>
                  </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                  <div class="kpi">
                    <div class="label">Last view</div>
                    <div class="value" id="kpiLastView">—</div>
                    <div class="small text-muted" id="kpiLastViewRel">—</div>
                  </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                  <div class="kpi">
                    <div class="label">Quiz attempts</div>
                    <div class="value" id="kpiQuiz">—</div>
                    <div class="small text-muted">unique submissions</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div class="row g-3">
            <div class="col-12 col-lg-8">
              <div class="card shadow-sm chart-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Views vs Quiz Attempts</h6>
                  <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="granularity" id="granDaily" value="daily" checked>
                    <label class="btn btn-outline-secondary" for="granDaily">Daily</label>
                    <input type="radio" class="btn-check" name="granularity" id="granWeekly" value="weekly">
                    <label class="btn btn-outline-secondary" for="granWeekly">Weekly</label>
                  </div>
                </div>
                <canvas id="viewsChart" style="width: 100%; height: auto; max-height: 400px !important;"></canvas>
              </div>
            </div>
            <div class="col-12 col-lg-4">
              <div class="card shadow-sm chart-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Completion Breakdown</h6>
                </div>
                <canvas id="completionChart" height="120"></canvas>
              </div>
            </div>
          </div>
        </section>

        <!-- Attendees table -->
        <section id="section-attendees" class="mt-4">
          <div class="card shadow-sm">
            <div class="section-header d-flex justify-content-between align-items-center">
              <h2 class="section-title"><i class="bi bi-people"></i> Students attending / watched</h2>
              <div class="d-flex gap-2">
                <input id="searchName" class="form-control form-control-sm" placeholder="Search name/email…"/>
                <button id="btnResetSearch" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-counterclockwise me-1"></i>Reset</button>
              </div>
            </div>
            <div class="p-3">
              <div class="table-responsive">
                <table id="attendeesTable" class="table table-striped align-middle w-100">
                  <thead>
                    <tr>
                      <th>Student</th>
                      <th>Email</th>
                      <th>Progress</th>
                      <th>Watched</th>
                      <th>Status</th>
                      <th>Last seen</th>
                      <th>Quiz</th>
                      <th class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== Utilities =====
    function parseQuery(){
      const q={};
      const qs = window.location.search.substring(1).split('&').filter(Boolean);
      for(const kv of qs){const [k,v] = kv.split('='); q[decodeURIComponent(k)] = decodeURIComponent(v||'');}
      return q;
    }
    function fmtDuration(sec){
      if(!sec && sec!==0) return '—';
      const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
      const mm = h? String(m).padStart(2,'0') : m; // show 2-digit m only when hours exist
      const ss = String(s).padStart(2,'0');
      return h? `${h}:${mm}:${ss}` : `${m}:${ss}`;
    }
    function relTime(iso){
      if(!iso) return '—';
      const d=new Date(iso); const diff=(Date.now()-d.getTime())/1000;
      if(diff<60) return 'just now';
      const mins=Math.floor(diff/60); if(mins<60) return mins+' min ago';
      const hrs=Math.floor(mins/60); if(hrs<24) return hrs+' h ago';
      const days=Math.floor(hrs/24); return days+' d ago';
    }

    // ===== Global state =====
    let courseId, lessonId, lessonTitle;
    let viewsChart, completionChart, attendeesTable;
    let refreshTimer=null;

    $(async function(){
      const q=parseQuery();
      courseId = q.course_id || q.courseId || '123';
      lessonId = q.lesson_id || q.lessonId || '201';
      lessonTitle = q.lesson_title || q.title || '';

      if(lessonTitle) document.getElementById('lessonTitleSpan').textContent = `— ${lessonTitle}`;
      document.getElementById('crumbCourse').href=`/educator/courses/${courseId}`;
      document.getElementById('crumbLessons').href=`/educator/courses/${courseId}/lessons`;
      document.getElementById('btnBackLessons').addEventListener('click',()=>{
        window.location.href=`/educator/courses/${courseId}/lessons`;
      });
      document.getElementById('btnOpenLesson').addEventListener('click',()=>{
        window.location.href=`/educator/courses/${courseId}/lessons/${lessonId}`;
      });

      // default date range: last 30 days
      const to=new Date();
      const from=new Date(); from.setDate(to.getDate()-29);
      document.getElementById('fromDate').value = from.toISOString().slice(0,10);
      document.getElementById('toDate').value   = to.toISOString().slice(0,10);
      document.getElementById('btnApplyRange').addEventListener('click',loadAnalytics);

      // Charts

      // Table
      initAttendeesTable();

      // First load
      await loadAnalytics();

      // Live refresh every 15s
      // refreshTimer = setInterval(loadPresence, 15000);
    });
      initCharts();


    function initCharts(){
      const ctx1=document.getElementById('viewsChart');
      viewsChart = new Chart(ctx1, {
        type:'line',
        data:{labels:[], datasets:[
          {label:'Views', data:[], tension:.35, borderWidth:2, pointRadius:0},
          {label:'Quiz attempts', data:[], tension:.35, borderWidth:2, pointRadius:0}
        ]},
        options:{
          responsive:true,
          maintainAspectRatio:false,
          interaction:{mode:'index', intersect:false},
          plugins:{legend:{display:true}},
          scales:{x:{grid:{display:false}}, y:{beginAtZero:true}}
        }
      });

      const ctx2=document.getElementById('completionChart');
      completionChart = new Chart(ctx2, {
        type:'doughnut',
        data:{labels:['Completed','In progress','Not started'], datasets:[{data:[0,0,0]}]},
        options:{plugins:{legend:{position:'bottom'}}}
      });

      // granularity switch
      document.querySelectorAll('input[name="granularity"]').forEach(r=>{
        r.addEventListener('change', loadAnalytics);
      });
    }

    async function loadAnalytics(){
      const from=document.getElementById('fromDate').value;
      const to=document.getElementById('toDate').value;
      const gran=document.querySelector('input[name="granularity"]:checked').value;

      try{
        const res = await fetch(`/api/courses/${courseId}/lessons/${lessonId}/analytics?from=${from}&to=${to}&gran=${gran}`);
        if(!res.ok) throw new Error('fail');
        const a = await res.json();
        applyAnalytics(a);
      }catch(e){
        // Demo fallback data
        const labels=[], views=[], quiz=[]; 
        for(let i=0;i<30;i++){labels.push(`Day ${i+1}`); views.push(20+Math.round(Math.random()*30)); quiz.push(Math.round(views[i]*0.35));}
        const nowCount = 7;
        applyAnalytics({
          attending_now: nowCount,
          watched_count: 312,
          last_view_at: new Date().toISOString(),
          quiz_attempts: 108,
          time_series: {labels, views, quiz_attempts:quiz},
          completion_breakdown: {completed:180, in_progress:90, not_started:42}
        });
      }

      // also refresh presence panel text
      // loadPresence();
    }

    function applyAnalytics(a){
      // KPIs
      document.getElementById('kpiAttending').textContent = a.attending_now ?? '—';
      document.getElementById('kpiAttendingHint').textContent = 'right now';
      document.getElementById('kpiWatched').textContent = a.watched_count ?? '—';
      document.getElementById('kpiLastView').textContent = a.last_view_at ? new Date(a.last_view_at).toLocaleString() : '—';
      document.getElementById('kpiLastViewRel').textContent = a.last_view_at ? relTime(a.last_view_at) : '—';
      document.getElementById('kpiQuiz').textContent = a.quiz_attempts ?? '—';

      // Charts
      if(a.time_series){
        viewsChart.data.labels = a.time_series.labels || [];
        viewsChart.data.datasets[0].data = a.time_series.views || [];
        viewsChart.data.datasets[1].data = a.time_series.quiz_attempts || [];
        viewsChart.update();
      }
      if(a.completion_breakdown){
        const d=a.completion_breakdown;
        completionChart.data.datasets[0].data=[d.completed||0,d.in_progress||0,d.not_started||0];
        completionChart.update();
      }
    }

    async function loadPresence(){
      try{
        const res = await fetch(`/api/courses/${courseId}/lessons/${lessonId}/presence`);
        if(!res.ok) throw new Error('fail');
        const p = await res.json();
        document.getElementById('kpiAttending').textContent = p.attending_now ?? document.getElementById('kpiAttending').textContent;
        document.getElementById('kpiAttendingHint').textContent = 'right now';
      }catch(e){ /* silent, keep previous */ }
    }

    function initAttendeesTable(){
      attendeesTable = $('#attendeesTable').DataTable({
        processing:true,
        deferRender:true,
        ajax:{
          url: `/api/courses/${courseId}/lessons/${lessonId}/attendees`,
          dataSrc:'',
          error: function(){
            const demo=[
              {id:1, name:'Ayesha Khan', email:'ayesha@example.com', avatar:'https://i.pravatar.cc/100?img=5', progress:100, watched_sec:1260, watching:true, last_seen:new Date().toISOString(), quiz_attempted:true, quiz_score:92},
              {id:2, name:'Omar Farooq', email:'omar@example.com', avatar:'https://i.pravatar.cc/100?img=15', progress:65, watched_sec:780, watching:false, last_seen:new Date(Date.now()-3600*1000).toISOString(), quiz_attempted:false, quiz_score:null},
              {id:3, name:'Liu Wei', email:'liu.wei@example.com', avatar:'https://i.pravatar.cc/100?img=25', progress:40, watched_sec:480, watching:false, last_seen:new Date(Date.now()-7200*1000).toISOString(), quiz_attempted:true, quiz_score:71}
            ];
            attendeesTable.clear().rows.add(demo).draw();
          }
        },
        columns:[
          {data:null, render:(row)=>`
            <div class="d-flex align-items-center gap-2">
              <img src="${row.avatar||'https://i.pravatar.cc/100?img=1'}" class="avatar" alt="${row.name}">
              <div>
                <div class="fw-semibold">${row.name||'—'}</div>
                <div class="text-muted small">ID: ${row.id}</div>
              </div>
            </div>`},
          {data:'email', defaultContent:'—'},
          {data:'progress', render:(p)=>{
            p = Number(p||0);
            return `<div class="d-flex align-items-center gap-2"><div class="progress flex-grow-1"><div class="progress-bar" role="progressbar" style="width:${p}%" aria-valuenow="${p}" aria-valuemin="0" aria-valuemax="100"></div></div><span class="small text-muted">${p}%</span></div>`;
          }},
          {data:'watched_sec', render:(s)=>fmtDuration(Number(s||0))},
          {data:'watching', render:(w)=> w? `<span class="status-badge status-watching">Watching now</span>` : `<span class="status-badge status-offline">Offline</span>`},
          {data:'last_seen', render:(d)=> d? `${new Date(d).toLocaleString()}<div class='small text-muted'>${relTime(d)}</div>` : '—'},
          {data:null, render:(row)=> row.quiz_attempted ? `Attempted <span class="badge text-bg-success ms-1">${row.quiz_score??'-'}%</span>` : '<span class="text-muted">Not attempted</span>'},
          {data:null, orderable:false, searchable:false, className:'text-end', render:(row)=> actionsHtml(row)}
        ],
        order:[[0,'asc']],
        pageLength:10,
        language:{search:'', searchPlaceholder:'Search…'},
        initComplete:function(){
          $('#searchName').on('input', function(){ attendeesTable.search(this.value).draw(); });
          $('#btnResetSearch').on('click', function(){ $('#searchName').val(''); attendeesTable.search('').draw(); });
        }
      });

      // Row actions handlers
      $('#attendeesTable').on('click','.act-profile',function(e){
        e.preventDefault();
        const row = attendeesTable.row($(this).closest('tr')).data();
        window.location.href = `/educator/students/${row.id}`;
      });
      $('#attendeesTable').on('click','.act-progress',function(e){
        e.preventDefault();
        const row = attendeesTable.row($(this).closest('tr')).data();
        window.location.href = `/educator/courses/${courseId}/lessons/${lessonId}/students/${row.id}`;
      });
      $('#attendeesTable').on('click','.act-message',function(e){
        e.preventDefault();
        const row = attendeesTable.row($(this).closest('tr')).data();
        window.location.href = `/educator/messages/compose?to=${encodeURIComponent(row.email||'')}`;
      });
    }

    function actionsHtml(row){
      return `
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-primary act-progress" title="View lesson progress"><i class="bi bi-bar-chart"></i></button>
          <button class="btn btn-sm btn-outline-primary act-profile" title="Open profile"><i class="bi bi-person"></i></button>
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="visually-hidden">More</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item act-message" href="#"><i class="bi bi-envelope me-2"></i>Message student</a></li>
          </ul>
        </div>`;
    }
  </script>
</body>
</html>
